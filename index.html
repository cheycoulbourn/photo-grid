// Storage handling functions
const STORAGE_KEY = 'gridImages';

function saveImagesToStorage(images) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(images));
}

function loadImagesFromStorage() {
    const saved = localStorage.getItem(STORAGE_KEY);
    return saved ? JSON.parse(saved) : Array(9).fill(null);
}

let cropper = null;
let activeGridItem = null;

function showStatus(message, duration = 2000) {
    const status = document.getElementById('statusMessage');
    status.textContent = message;
    status.style.display = 'block';
    setTimeout(() => {
        status.style.display = 'none';
    }, duration);
}

function updateStorageForItem(gridItem) {
    const img = gridItem.querySelector('img');
    const index = parseInt(img.dataset.index);
    const images = loadImagesFromStorage();
    images[index] = img.style.display !== 'none' ? img.src : null;
    saveImagesToStorage(images);
}

function setupGridItem(gridItem) {
    const fileInput = gridItem.querySelector('.file-input');
    const uploadOverlay = gridItem.querySelector('.upload-overlay');
    const img = gridItem.querySelector('img');
    const cropButton = gridItem.querySelector('.crop-button');
    const removeButton = gridItem.querySelector('.remove-button');

    uploadOverlay.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = (e) => {
                img.src = e.target.result;
                img.style.display = 'block';
                uploadOverlay.style.display = 'none';
                updateStorageForItem(gridItem);
                showStatus('Image uploaded');
            };

            reader.readAsDataURL(file);
        }
    });

    cropButton.addEventListener('click', () => {
        activeGridItem = gridItem;
        const modalImg = document.getElementById('cropImage');
        modalImg.src = img.src;
        document.getElementById('cropModal').style.display = 'block';
        
        if (cropper) {
            cropper.destroy();
        }
        
        cropper = new Cropper(modalImg, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1,
        });
    });

    removeButton.addEventListener('click', () => {
        img.src = '';
        img.style.display = 'none';
        uploadOverlay.style.display = 'flex';
        fileInput.value = '';
        updateStorageForItem(gridItem);
        showStatus('Image removed');
    });
}

function closeModal() {
    document.getElementById('cropModal').style.display = 'none';
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

function cropImage() {
    if (!cropper || !activeGridItem) return;
    
    const croppedCanvas = cropper.getCroppedCanvas();
    const img = activeGridItem.querySelector('img');
    img.src = croppedCanvas.toDataURL();
    updateStorageForItem(activeGridItem);
    
    closeModal();
    showStatus('Image cropped');
}

function createGridItems() {
    const container = document.querySelector('.grid-container');
    const savedImages = loadImagesFromStorage();
    
    for (let i = 1; i <= 9; i++) {
        const gridItem = document.createElement('div');
        gridItem.className = 'grid-item';
        gridItem.innerHTML = `
            <div class="image-container">
                <img style="display: none;" alt="Image ${i}" data-index="${i-1}">
                <div class="upload-overlay">
                    <svg class="upload-icon" viewBox="0 0 24 24">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    <div class="upload-text">Add Image</div>
                </div>
                <div class="button-container">
                    <button class="icon-button crop-button" title="Crop">✂</button>
                    <button class="icon-button remove-button">×</button>
                </div>
            </div>
            <input type="file" class="file-input" accept="image/*">
        `;
        
        setupGridItem(gridItem);
        
        // Restore saved image if exists
        const img = gridItem.querySelector('img');
        const uploadOverlay = gridItem.querySelector('.upload-overlay');
        const savedImage = savedImages[i-1];
        
        if (savedImage) {
            img.src = savedImage;
            img.style.display = 'block';
            uploadOverlay.style.display = 'none';
        }
        
        container.appendChild(gridItem);
    }
}

document.addEventListener('DOMContentLoaded', createGridItems);
