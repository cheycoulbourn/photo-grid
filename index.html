<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.js"></script>
    <style>
        /* ... (keep existing styles) ... */
    </style>
</head>
<body>
    <div class="grid-container"></div>
    
    <div class="modal" id="cropModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Crop Image</h3>
                <button class="icon-button" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <img id="cropImage" style="max-width: 100%; max-height: 100%;">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="cropImage()">Apply</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase (keep your existing config)
        const firebaseConfig = {
            apiKey: "AIzaSyA-7A_QOV-W0tCtlG-vJB5nTKxjnhK3Zrk",
            authDomain: "image-grid-1d9d4.firebaseapp.com",
            projectId: "image-grid-1d9d4",
            storageBucket: "image-grid-1d9d4.firebasestorage.app",
            messagingSenderId: "685249777137",
            appId: "1:685249777137:web:b1c1daecd19b94b0784850",
            measurementId: "G-WZMSH9YQK5"
        };

        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        let userId = null;

        // Anonymous authentication
        firebase.auth().signInAnonymously()
            .then((userCredential) => {
                userId = userCredential.user.uid;
                loadImages();
            })
            .catch((error) => {
                console.error("Auth error:", error);
            });

        let cropper = null;
        let activeGridItem = null;

        async function saveImage(index, file) {
            if (!userId) return null;
            
            try {
                // Create a reference to the file location
                const imageRef = storage.ref(`users/${userId}/image${index}.jpg`);
                
                // Upload the file directly
                const snapshot = await imageRef.put(file, {
                    contentType: 'image/jpeg'
                });
                
                // Get the download URL
                const downloadURL = await snapshot.ref.getDownloadURL();
                return downloadURL;
            } catch (error) {
                console.error('Error in saveImage:', error);
                throw error;
            }
        }

        async function loadImages() {
            if (!userId) return;

            for (let i = 0; i < 9; i++) {
                try {
                    const imageRef = storage.ref(`users/${userId}/image${i}.jpg`);
                    const url = await imageRef.getDownloadURL();
                    const img = document.querySelector(`img[data-index="${i}"]`);
                    if (img) {
                        img.src = url;
                        img.style.display = 'block';
                        img.closest('.grid-item').querySelector('.upload-overlay').style.display = 'none';
                    }
                } catch (error) {
                    if (error.code !== 'storage/object-not-found') {
                        console.error(`Error loading image ${i}:`, error);
                    }
                }
            }
        }

        function setupGridItem(gridItem) {
            const fileInput = gridItem.querySelector('.file-input');
            const uploadOverlay = gridItem.querySelector('.upload-overlay');
            const img = gridItem.querySelector('img');
            const cropButton = gridItem.querySelector('.crop-button');
            const removeButton = gridItem.querySelector('.remove-button');
            const loadingOverlay = gridItem.querySelector('.loading-overlay');

            uploadOverlay.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', async (e) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    loadingOverlay.style.display = 'flex';
                    
                    try {
                        // Create a preview
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            img.src = event.target.result;
                            img.style.display = 'block';
                            uploadOverlay.style.display = 'none';
                        };
                        reader.readAsDataURL(file);

                        // Upload the original file
                        const index = img.dataset.index;
                        await saveImage(index, file);
                    } catch (error) {
                        console.error('Error uploading image:', error);
                        alert('Failed to upload image. Please try again.');
                        img.style.display = 'none';
                        uploadOverlay.style.display = 'flex';
                    } finally {
                        loadingOverlay.style.display = 'none';
                    }
                }
            });

            removeButton.addEventListener('click', async () => {
                if (!userId) return;
                
                const index = img.dataset.index;
                loadingOverlay.style.display = 'flex';
                
                try {
                    const imageRef = storage.ref(`users/${userId}/image${index}.jpg`);
                    await imageRef.delete();
                    
                    img.src = '';
                    img.style.display = 'none';
                    uploadOverlay.style.display = 'flex';
                    fileInput.value = '';
                } catch (error) {
                    console.error('Error removing image:', error);
                    alert('Failed to remove image. Please try again.');
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            });

            cropButton.addEventListener('click', () => {
                activeGridItem = gridItem;
                const modalImg = document.getElementById('cropImage');
                modalImg.src = img.src;
                document.getElementById('cropModal').style.display = 'block';
                
                if (cropper) {
                    cropper.destroy();
                }
                
                cropper = new Cropper(modalImg, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                });
            });
        }

        async function cropImage() {
            if (!cropper || !activeGridItem) return;
            
            const loadingOverlay = activeGridItem.querySelector('.loading-overlay');
            loadingOverlay.style.display = 'flex';
            
            try {
                const croppedCanvas = cropper.getCroppedCanvas();
                
                // Get the cropped image as a blob
                const blob = await new Promise(resolve => {
                    croppedCanvas.toBlob(resolve, 'image/jpeg', 0.9);
                });
                
                const img = activeGridItem.querySelector('img');
                const index = img.dataset.index;
                
                // Save the cropped image
                const url = await saveImage(index, blob);
                img.src = url;
                closeModal();
            } catch (error) {
                console.error('Error cropping image:', error);
                alert('Failed to save cropped image. Please try again.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function createGridItems() {
            const container = document.querySelector('.grid-container');
            for (let i = 1; i <= 9; i++) {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                gridItem.innerHTML = `
                    <div class="image-container">
                        <img style="display: none;" alt="Image ${i}" data-index="${i-1}">
                        <div class="upload-overlay">
                            <svg class="upload-icon" viewBox="0 0 24 24">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            <div class="upload-text">Add Image</div>
                        </div>
                        <div class="button-container">
                            <button class="icon-button crop-button" title="Crop">✂</button>
                            <button class="icon-button remove-button">×</button>
                        </div>
                        <div class="loading-overlay">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                    <input type="file" class="file-input" accept="image/*">
                `;
                
                setupGridItem(gridItem);
                container.appendChild(gridItem);
            }
        }

        function closeModal() {
            document.getElementById('cropModal').style.display = 'none';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }

        document.addEventListener('DOMContentLoaded', createGridItems);
    </script>
</body>
</html>
